<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Novel Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .frame:hover {
            border-color: #3b82f6;
            transform: scale(1.05);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        #choicePopup, #previewPopup {
            z-index: 1000;
        }
        .remove-btn:hover {
            background-color: #dc2626;
            animation: pulse 0.5s infinite;
        }
        #downloadXmlBtn:hover {
            background-color: #15803d;
            animation: pulse 0.5s infinite;
        }
        .time-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.3s ease;
        }
        .time-item:hover {
            transform: translateY(-2px);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        .popup-enter {
            animation: popupEnter 0.3s ease-out;
        }
        #previewPopup iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes popupEnter {
            from {
                opacity: 0;
                transform: scale(0.8) translate(-50%, -50%);
            }
            to {
                opacity: 1;
                transform: scale(1) translate(-50%, -50%);
            }
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full p-6 fade-in">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Video Novel Engine VNE demo</h1>
        
        <div id="videoContainer" class="mb-6">
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="videoUrlInput" placeholder="Enter video URL" class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                <button onclick="loadVideo()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">Load Video</button>
            </div>
            <div class="relative">
                <video id="videoPlayer" class="w-full rounded-lg shadow-md" crossOrigin="anonymous" style="display: none;"></video>
                <div class="absolute bottom-4 left-4 flex gap-2">
                    <button onclick="togglePlayPause()" id="playPauseBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300" style="display: none;">Play</button>
                </div>
            </div>
        </div>

        <div id="timeControls" class="flex flex-col sm:flex-row gap-4 items-center mb-6">
            <input type="range" id="timeSlider" min="0" max="100" step="0.1" value="0" disabled class="w-full sm:w-1/2">
            <input type="number" id="timeInput" min="0" step="0.1" placeholder="Time (seconds)" class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <button onclick="addTime()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">Add Time</button>
            <button onclick="extractFrames()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-300">Extract Frames</button>
            <button id="downloadXmlBtn" onclick="generateXML()" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition duration-300">Download .vne</button>
            <button onclick="showPreview()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">Preview</button>
        </div>

        <p class="text-gray-600 mb-4">Total Frames: <span id="frameCount" class="font-semibold">0</span> | Selected times: <span id="timeList" class="inline-flex flex-wrap gap-2"></span></p>

        <div id="extractorContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6"></div>

        <div id="choicePopup" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 w-full max-w-md popup-enter">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Add Choice, Subtitle, or MP3</h3>
            <input type="text" id="choiceText" placeholder="Choice text (optional)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="text" id="subtitleText" placeholder="Subtitle text (optional)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="text" id="mp3Link" placeholder="MP3 URL (optional)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="text" id="backgroundButtonColor" placeholder="Button color (#000000)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="number" id="width" placeholder="Width (px)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="number" id="height" placeholder="Height (px)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="text" id="borderRadius" placeholder="Border Radius (8px, 50%)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="number" id="top" placeholder="Top (px)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <input type="number" id="left" placeholder="Left (px)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <select id="choiceAction" class="p-2 border border-gray-300 rounded-lg w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                <option value="continue">Continue Video</option>
                <option value="link">Link to Website</option>
            </select>
            <input type="text" id="choiceUrl" placeholder="Website URL (if applicable)" class="p-2 border border-gray-300 rounded-lg w-full mb-3 hidden focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
            <div class="flex gap-2">
                <button onclick="saveChoiceOrSubtitle()" class="bg-green-600 text-white px-4 py-2 rounded-lg flex-1 transition duration-300">Save</button>
                <button onclick="closePopup()" class="bg-gray-600 text-white px-4 py-2 rounded-lg flex-1 transition duration-300">Cancel</button>
            </div>
        </div>

        <div id="previewPopup" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center popup-enter">
            <div class="relative w-full h-full max-w-7xl max-h-[90vh] bg-white rounded-lg overflow-hidden">
                <div class="absolute bottom-4 left-4 flex gap-2">
                    <button onclick="reloadPreview()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-300">Reload</button>
                    <button onclick="closePreview()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">Close</button>
                </div>
                <iframe id="previewFrame" src="./preview.html" class="w-full h-full"></iframe>
            </div>
        </div>
    </div>

    <script>
        const videoUrlInput = document.getElementById('videoUrlInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const timeSlider = document.getElementById('timeSlider');
        const timeInput = document.getElementById('timeInput');
        const timeList = document.getElementById('timeList');
        const frameCount = document.getElementById('frameCount');
        const extractorContainer = document.getElementById('extractorContainer');
        const choicePopup = document.getElementById('choicePopup');
        const choiceText = document.getElementById('choiceText');
        const subtitleText = document.getElementById('subtitleText');
        const mp3Link = document.getElementById('mp3Link');
        const backgroundButtonColor = document.getElementById('backgroundButtonColor');
        const widthInput = document.getElementById('width');
        const heightInput = document.getElementById('height');
        const borderRadiusInput = document.getElementById('borderRadius');
        const topbutton = document.getElementById('top');
        const leftbutton = document.getElementById('left');
        const choiceAction = document.getElementById('choiceAction');
        const choiceUrl = document.getElementById('choiceUrl');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const previewPopup = document.getElementById('previewPopup');
        const previewFrame = document.getElementById('previewFrame');
        let selectedTimes = [];
        let choices = {};
        let subtitles = {};
        let mp3Links = {};
        let currentFrameTime = null;
        let videoUrl = '';
        let url = '';

        function loadVideo() {
            const url = videoUrlInput.value.trim();
            if (url) {
                try {
                    new URL(url);
                    videoPlayer.src = url;
                    videoPlayer.crossOrigin = 'anonymous';
                    videoPlayer.style.display = 'block';
                    playPauseBtn.style.display = 'block';
                    videoPlayer.load();
                    videoUrl = url;
                    videoUrlInput.value = '';
                    playPauseBtn.textContent = 'Play';
                } catch (e) {
                    alert('Please enter a valid URL.');
                    videoPlayer.style.display = 'none';
                    playPauseBtn.style.display = 'none';
                }
            } else {
                alert('Please enter a video URL.');
                videoPlayer.style.display = 'none';
                playPauseBtn.style.display = 'none';
            }
        }

        function togglePlayPause() {
            if (videoPlayer.paused) {
                videoPlayer.play();
                playPauseBtn.textContent = 'Pause';
            } else {
                videoPlayer.pause();
                playPauseBtn.textContent = 'Play';
            }
        }

        videoPlayer.addEventListener('loadedmetadata', () => {
            timeSlider.max = videoPlayer.duration;
            timeSlider.disabled = false;
            timeInput.max = videoPlayer.duration;
            timeInput.placeholder = `Time (0-${videoPlayer.duration.toFixed(1)}s)`;
            videoPlayer.style.display = 'block';
            playPauseBtn.style.display = 'block';
        });

        videoPlayer.addEventListener('error', () => {
            alert('Failed to load video. Please ensure the URL is valid and the server supports CORS.');
            videoPlayer.style.display = 'none';
            playPauseBtn.style.display = 'none';
        });

        timeSlider.addEventListener('input', () => {
            timeInput.value = timeSlider.value;
            videoPlayer.currentTime = timeSlider.value;
        });

        timeInput.addEventListener('input', () => {
            const value = parseFloat(timeInput.value);
            if (!isNaN(value) && value >= 0 && value <= videoPlayer.duration) {
                timeSlider.value = value;
                videoPlayer.currentTime = value;
            }
        });

        choiceAction.addEventListener('change', () => {
            choiceUrl.classList.toggle('hidden', choiceAction.value !== 'link');
            if (choiceAction.value === 'link') {
                choiceUrl.focus();
            }
        });

        function addTime() {
            const time = parseFloat(timeInput.value || timeSlider.value);
            if (!isNaN(time) && time >= 0 && time <= videoPlayer.duration) {
                if (selectedTimes.includes(time)) {
                    alert('This time is already added. Please choose a different time.');
                    return;
                }
                selectedTimes.push(time);
                updateTimeList();
                timeInput.value = '';
                timeSlider.value = 0;
            } else {
                alert('Please enter a valid time within the video duration.');
            }
        }

        function removeTime(time) {
            selectedTimes = selectedTimes.filter(t => t !== time);
            delete choices[time];
            delete subtitles[time];
            delete mp3Links[time];
            updateTimeList();
            extractFrames();
        }

        function updateTimeList() {
            timeList.innerHTML = '';
            frameCount.textContent = selectedTimes.length;
            selectedTimes.forEach((time, index) => {
                const timeItem = document.createElement('span');
                timeItem.className = 'time-item bg-gray-200 text-gray-700 px-2 py-1 rounded-lg';
                timeItem.textContent = `${time.toFixed(1)}s`;
                timeItem.style.animationDelay = `${index * 0.1}s`;
                const removeIcon = document.createElement('span');
                removeIcon.textContent = 'Ã—';
                removeIcon.className = 'cursor-pointer text-red-500 hover:text-red-700';
                removeIcon.onclick = () => removeTime(time);
                timeItem.appendChild(removeIcon);
                timeList.appendChild(timeItem);
            });
        }

        function showPopup(time) {
            currentFrameTime = time;
            choicePopup.classList.remove('hidden');
            choiceText.value = '';
            subtitleText.value = subtitles[time] || '';
            mp3Link.value = mp3Links[time] || '';
            backgroundButtonColor.value = '';
            widthInput.value = '';
            heightInput.value = '';
            borderRadiusInput.value = '';
            topbutton.value = '';
            leftbutton.value = '';
            choiceAction.value = 'continue';
            choiceUrl.classList.add('hidden');
            choiceUrl.value = '';
        }

        function closePopup() {
            choicePopup.classList.add('hidden');
            currentFrameTime = null;
        }

        function showPreview() {
            previewPopup.classList.remove('hidden');
        }

        function closePreview() {
            previewPopup.classList.add('hidden');
        }

        function reloadPreview() {
            const iframe = document.getElementById('previewFrame');
            iframe.src = iframe.src; // Reloads the iframe by resetting its src
        }

        function saveChoiceOrSubtitle() {
            if (!currentFrameTime) {
                alert('Error: No frame time selected. Please try again.');
                return;
            }

            const choice = choiceText.value.trim();
            const subtitle = subtitleText.value.trim();
            const mp3 = mp3Link.value.trim();
            const bgColor = backgroundButtonColor.value.trim();
            const width = widthInput.value.trim();
            const height = heightInput.value.trim();
            const borderRadius = borderRadiusInput.value.trim();
            const topbtn = topbutton.value.trim();
            const leftbtn = leftbutton.value.trim();

            if (!choice && !subtitle && !mp3) {
                alert('Please enter either choice text, subtitle text, or an MP3 URL.');
                return;
            }

            if (subtitle) {
                if (subtitles[currentFrameTime]) {
                    alert('A subtitle already exists for this frame.');
                    return;
                }
                subtitles[currentFrameTime] = subtitle;
            }

            if (mp3) {
                if (mp3Links[currentFrameTime]) {
                    alert('An MP3 link already exists for this frame.');
                    return;
                }
                try {
                    new URL(mp3);
                    mp3Links[currentFrameTime] = mp3;
                } catch (e) {
                    alert('Please enter a valid MP3 URL.');
                    return;
                }
            }

            if (choice) {
                const action = choiceAction.value;
                let data = { text: choice, action };

                if (topbtn) {
                    data.top = Number(topbtn) || 0;
                }

                if (leftbtn) {
                    data.left = Number(leftbtn) || 0;
                }

                if (bgColor && /^#[0-9A-Fa-f]{6}$/.test(bgColor)) {
                    data.backgroundButtonColor = bgColor;
                } else if (bgColor) {
                    alert('Please enter a valid #hex color (e.g., #FF0000).');
                    return;
                }

                if (width) {
                    const widthNum = Number(width);
                    if (isNaN(widthNum) || widthNum <= 0) {
                        alert('Please enter a valid positive number for width.');
                        return;
                    }
                    data.width = widthNum;
                }

                if (height) {
                    const heightNum = Number(height);
                    if (isNaN(heightNum) || heightNum <= 0) {
                        alert('Please enter a valid positive number for height.');
                        return;
                    }
                    data.height = heightNum;
                }

                if (borderRadius) {
                    if (!/^\d+(px|%)$/.test(borderRadius)) {
                        alert('Please enter a valid border-radius (e.g., 8px or 50%).');
                        return;
                    }
                    data.borderRadius = borderRadius;
                }

                if (action === 'link') {
                    const url = choiceUrl.value.trim();
                    if (!url) {
                        alert('Please enter a valid URL.');
                        return;
                    }
                    data.url = url;
                } else if (action === 'continue') {
                    data.time = currentFrameTime;
                }

                if (!choices[currentFrameTime]) {
                    choices[currentFrameTime] = [];
                }

                if (choices[currentFrameTime].length >= 3) {
                    alert('Maximum 3 choices allowed per frame.');
                    return;
                }

                choices[currentFrameTime].push(data);
            }

            closePopup();
            extractFrames();
        }

        function executeChoice(action, data) {
            if (action === 'link') {
                window.open(data.url, '_blank');
            } else if (action === 'continue') {
                videoPlayer.currentTime = data.time;
            }
        }

        function simpleEncode(str) {
            let result = '';
            for (let char of str) {
                let code = char.charCodeAt(0);
                if (code >= 32 && code <= 126) {
                    code = ((code - 32 + 5) % 95) + 32;
                }
                result += String.fromCharCode(code);
            }
            return result;
        }
        
        function generateXML() {
            if (!videoUrl) {
                alert('Please load a video URL first.');
                return;
            }
            if (selectedTimes.length === 0 && Object.keys(choices).length === 0) {
                alert('No choices or times to export. Please add some choices first.');
                return;
            }
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<VisualNovelChoices>\n';
            xml += `  <VideoURL>${escapeXML(videoUrl)}</VideoURL>\n`;
            for (const time of selectedTimes) {
                xml += `  <Frame time="${time.toFixed(1)}">\n`;
                if (subtitles[time]) {
                    xml += `    <Subtitle>${escapeXML(subtitles[time])}</Subtitle>\n`;
                }
                if (mp3Links[time]) {
                    xml += `    <MP3>${escapeXML(mp3Links[time])}</MP3>\n`;
                }
                if (choices[time] && choices[time].length > 0) {
                    choices[time].forEach(choice => {
                        xml += `    <Choice>\n`;
                        xml += `      <Text>${escapeXML(choice.text)}</Text>\n`;
                        xml += `      <Action>${choice.action}</Action>\n`;
                        if (choice.backgroundButtonColor) {
                            xml += `      <BackgroundButtonColor>${escapeXML(choice.backgroundButtonColor)}</BackgroundButtonColor>\n`;
                        }
                        if (choice.width) {
                            xml += `      <Width>${choice.width}</Width>\n`;
                        }
                        if (choice.height) {
                            xml += `      <Height>${choice.height}</Height>\n`;
                        }
                        if (choice.borderRadius) {
                            xml += `      <BorderRadius>${escapeXML(choice.borderRadius)}</BorderRadius>\n`;
                        }
                        if (choice.left) {
                            xml += `      <Left>${choice.left}</Left>\n`;
                        }
                        if (choice.top) {
                            xml += `      <Top>${choice.top}</Top>\n`;
                        }
                        if (choice.action === 'link') {
                            xml += `      <Url>${escapeXML(choice.url)}</Url>\n`;
                        } else if (choice.action === 'continue') {
                            xml += `      <Time>${choice.time.toFixed(1)}</Time>\n`;
                        }
                        xml += `    </Choice>\n`;
                    });
                }
                xml += `  </Frame>\n`;
            }
            xml += '</VisualNovelChoices>';

            const encodedXml = simpleEncode(xml);
            const zip = new JSZip();
            zip.file('data.vne', encodedXml);
            zip.generateAsync({ type: 'blob' }).then(function (content) {
                url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data.vne';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }).catch(function (err) {
                alert('Error generating ZIP file: ' + err.message);
            });
        }

        function escapeXML(str) {
            return str.replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;')
                     .replace(/"/g, '&quot;')
                     .replace(/'/g, '&apos;');
        }

        function extractFrames() {
            if (!videoPlayer.src || selectedTimes.length === 0) {
                alert('Please load a video and add at least one time.');
                return;
            }

            extractorContainer.innerHTML = '';
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = videoPlayer.videoWidth;
            canvas.height = videoPlayer.videoHeight;

            function captureFrame(time) {
                return new Promise((resolve, reject) => {
                    videoPlayer.currentTime = time;
                    videoPlayer.onseeked = () => {
                        try {
                            context.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
                            const frameContainer = document.createElement('div');
                            frameContainer.className = 'frame-container text-center slide-in';
                            frameContainer.style.animationDelay = `${selectedTimes.indexOf(time) * 0.1}s`;
                            const img = document.createElement('img');
                            img.src = canvas.toDataURL('image/png');
                            img.className = 'frame w-full rounded-lg border border-gray-300';
                            img.alt = `Frame at ${time} seconds`;
                            img.onclick = () => showPopup(time);
                            const timeLabel = document.createElement('p');
                            timeLabel.className = 'text-gray-600 mt-2';
                            timeLabel.textContent = `${time.toFixed(1)}s`;
                            frameContainer.appendChild(img);
                            frameContainer.appendChild(timeLabel);

                            if (subtitles[time]) {
                                const subtitleElement = document.createElement('p');
                                subtitleElement.className = 'text-gray-500 text-sm mt-1 break-words';
                                subtitleElement.textContent = `Subtitle: ${subtitles[time]}`;
                                frameContainer.appendChild(subtitleElement);
                            }

                            if (mp3Links[time]) {
                                const mp3Element = document.createElement('p');
                                mp3Element.className = 'text-gray-500 text-sm mt-1 break-words';
                                mp3Element.textContent = `MP3: ${mp3Links[time]}`;
                                frameContainer.appendChild(mp3Element);
                            }

                            if (choices[time] && choices[time].length > 0) {
                                const choicesList = document.createElement('div');
                                choicesList.className = 'choices-list mt-2 text-sm';
                                choices[time].forEach((choice, index) => {
                                    const choiceItem = document.createElement('button');
                                    choiceItem.className = 'choice-item text-white px-3 py-1 rounded-lg mt-1 transition duration-300';
                                    choiceItem.textContent = choice.text;
                                    choiceItem.style.background = 'rgb(22 163 74 / var(--tw-bg-opacity, 1))';
                                    choiceItem.style.animationDelay = `${index * 0.1}s`;
                                    choiceItem.className += ' slide-in';
                                    choiceItem.onclick = () => executeChoice(choice.action, choice);
                                    choicesList.appendChild(choiceItem);
                                });
                                frameContainer.appendChild(choicesList);
                            }

                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-btn bg-red-500 text-white px-2 py-1 rounded-lg mt-2 transition duration-300';
                            removeBtn.textContent = 'Remove';
                            removeBtn.onclick = () => removeTime(time);
                            frameContainer.appendChild(removeBtn);

                            extractorContainer.appendChild(frameContainer);
                            resolve();
                        } catch (e) {
                            reject(new Error('Failed to capture frame due to CORS restrictions. Please ensure the video server supports CORS and try again.'));
                        }
                    };
                    videoPlayer.onerror = () => {
                        reject(new Error('Error seeking video. Please ensure the video is accessible.'));
                    };
                });
            }

            async function processFrames() {
                try {
                    for (const time of selectedTimes) {
                        await captureFrame(time);
                    }
                    videoPlayer.onseeked = null;
                    videoPlayer.onerror = null;
                } catch (error) {
                    alert(error.message);
                }
            }

            processFrames();
        }
    </script>
</body>
</html>